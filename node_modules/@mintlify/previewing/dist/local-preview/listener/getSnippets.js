import { optionallyAddLeadingSlash, replaceVariables, isSnippetExtension, isImportedAsSnippet, } from '@mintlify/common';
import { getFileListSync, preparseMdxTree, getFileExtension } from '@mintlify/prebuild';
import { promises as _promises } from 'fs';
import { join } from 'path';
import { CMD_EXEC_PATH, NEXT_PUBLIC_PATH } from '../../constants.js';
import { getImportedFilesFromCache } from './importCache.js';
import { handleParseError, getCurrentVariables } from './utils.js';
const { readFile } = _promises;
const getSnippetBase = async (baseDir) => {
    const importedFiles = getImportedFilesFromCache();
    const variables = await getCurrentVariables();
    const allSnippetFilenames = getFileListSync(baseDir).filter((file) => {
        if (!isSnippetExtension(getFileExtension(file))) {
            return false;
        }
        if (file.startsWith('snippets/') || file.startsWith('_snippets/')) {
            return true;
        }
        if (getFileExtension(file) === 'jsx') {
            return true;
        }
        return isImportedAsSnippet(file, importedFiles);
    });
    const promises = allSnippetFilenames.map(async (snippetFilename) => {
        try {
            const tree = await preparseMdxTree(replaceVariables((await readFile(join(baseDir, snippetFilename))).toString(), variables), baseDir, join(baseDir, snippetFilename), handleParseError);
            return {
                filename: optionallyAddLeadingSlash(snippetFilename),
                tree,
            };
        }
        catch (err) {
            console.warn(`Error reading snippet file ${snippetFilename}`);
            return;
        }
    });
    return (await Promise.all(promises)).filter(Boolean);
};
export const getProcessedSnippets = () => getSnippetBase(NEXT_PUBLIC_PATH);
export const getOriginalSnippets = () => getSnippetBase(CMD_EXEC_PATH);
